import{u as ie,b as M,S as se,C as oe,U as D}from"./chunk-VTDYXPA4-C76XG5MC.js";import{C as O,R as j,I}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{D as ne}from"./chunk-53RYGJCD-CGPAqcVR.js";import{c as R}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as te}from"./chunk-6HTZNHPT-CWLYyxUQ.js";import{R as S,u as A,a as ce,S as ae}from"./chunk-4TC5YS65-DuWBZ5Fx.js";import{Y as le,ay as de,j as o,b as ue,r as w,ae as pe,g as me,i as fe,l as ge,t as F,B as N,ah as he,a8 as _e,aw as T,aa as y,aj as k,al as B}from"./index-DJprrk-h.js";import{d as ye,c as Se}from"./chunk-GRT22PE5-BhntuYcy.js";import"./chunk-PDWBYQOW-Dmlh1vBq.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./index.esm-DcpsjfTp.js";import"./x-mark-mini-CCZ8SXPz.js";import"./Trans-BXeFa3Vj.js";import"./currency-input-DvMtmylE.js";import"./_isIndex-CODICcj5.js";import"./index-ASO6e3h-.js";import"./prompt-fnnplrMf.js";var xe=_e({region_prices:T(y(),y().or(B()).optional()),currency_prices:T(y(),y().or(B()).optional()),conditional_region_prices:T(y(),k(D)),conditional_currency_prices:T(y(),k(D))});function je({shippingOption:i}){const{t:e}=ue(),{handleSuccess:p}=A(),{getIsOpen:a,setIsOpen:u}=ce(),[f,r]=w.useState(null),h=t=>{u(O,!0),r(t)},_=()=>{u(O,!1),r(null)},m=pe({defaultValues:Pe(i.prices),resolver:he(xe)}),{mutateAsync:n,isPending:l}=Se(i.id),{store:b,isLoading:V,isError:q,error:z}=me(),x=w.useMemo(()=>{var t;return((t=b==null?void 0:b.supported_currencies)==null?void 0:t.map(v=>v.currency_code))||[]},[b]),{regions:g,isLoading:K,isError:G,error:$}=fe({fields:"id,name,currency_code",limit:999}),{price_preferences:H}=ge({}),{setCloseOnEscape:Y}=A(),Z=ie({name:i.name,currencies:x,regions:g,pricePreferences:H}),J=w.useMemo(()=>[[...x||[],...g||[]]],[x,g]),L=m.handleSubmit(async t=>{const v=Object.entries(t.currency_prices).map(([s,c])=>{if(!c||!x.some(E=>E.toLowerCase()===s.toLowerCase()))return;const d={currency_code:s,amount:R(c)},C=i.prices.find(E=>E.currency_code===s&&!E.price_rules.length);return C&&(d.id=C.id),d}).filter(s=>!!s),W=Object.entries(t.conditional_currency_prices).flatMap(([s,c])=>c==null?void 0:c.map(d=>({id:d.id,currency_code:s,amount:R(d.amount),rules:M(d)}))),X=Object.entries(t.region_prices).map(([s,c])=>!c||!(g!=null&&g.some(C=>C.id===s))?void 0:{region_id:s,amount:R(c)}).filter(s=>!!s),ee=Object.entries(t.conditional_region_prices).flatMap(([s,c])=>c==null?void 0:c.map(d=>({id:d.id,region_id:s,amount:R(d.amount),rules:M(d)}))),re=[...v,...W,...X,...ee];await n({prices:re},{onSuccess:()=>{F.success(e("general.success")),p()},onError:s=>{F.error(s.message)}})}),Q=V||K||!x||!g;if(q)throw z;if(G)throw $;return o.jsx(S.Form,{form:m,children:o.jsxs(te,{className:"flex h-full flex-col overflow-hidden",onSubmit:L,children:[o.jsx(S.Header,{}),o.jsx(S.Body,{children:o.jsx(ae,{id:O,onOpenChangeCallback:t=>{t||r(null)},children:o.jsxs(se,{onOpenConditionalPricesModal:h,onCloseConditionalPricesModal:_,children:[o.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:o.jsx(ne,{isLoading:Q,data:J,columns:Z,state:m,onEditingChange:t=>Y(!t),disableInteractions:a(O)})}),f&&o.jsx(oe,{info:f,variant:"update"})]})})}),o.jsx(S.Footer,{children:o.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[o.jsx(S.Close,{asChild:!0,children:o.jsx(N,{variant:"secondary",size:"small",children:e("actions.cancel")})}),o.jsx(N,{size:"small",className:"whitespace-nowrap",isLoading:l,onClick:L,type:"button",children:e("actions.save")})]})})]})})}var P=(i,e)=>{var a;const p=["eq","gt","lt"].includes(e)?void 0:null;return((a=i==null?void 0:i.find(u=>u.attribute===I&&u.operator===e))==null?void 0:a.value)||p},U=i=>{const e=i.price_rules||[];return{id:i.id,amount:i.amount,gte:P(e,"gte"),lte:P(e,"lte"),gt:P(e,"gt"),lt:P(e,"lt"),eq:P(e,"eq")}},Pe=i=>{const e=(r,h,_=[])=>{var n;const m=((n=r.price_rules)==null?void 0:n.map(l=>l.attribute))||[];return h.every(l=>m.includes(l))&&!_.some(l=>m.includes(l))},p={},a={},u={},f={};return i.forEach(r=>{var h,_,m;if(!((h=r.price_rules)!=null&&h.length)){p[r.currency_code]=r.amount;return}if(e(r,[I],[j])){const n=r.currency_code;a[n]||(a[n]=[]),a[n].push(U(r));return}if(e(r,[j],[I])){const n=(_=r.price_rules.find(l=>l.attribute===j))==null?void 0:_.value;u[n]=r.amount;return}if(e(r,[j,I])){const n=(m=r.price_rules.find(l=>l.attribute===j))==null?void 0:m.value;f[n]||(f[n]=[]),f[n].push(U(r))}}),{currency_prices:p,conditional_currency_prices:a,region_prices:u,conditional_region_prices:f}};function Ue(){const{so_id:i,location_id:e}=le();if(!i)throw de({message:"Shipping Option ID paramater is missing",status:404});const{shipping_option:p,isError:a,error:u}=ye(i,{fields:"*prices,*prices.price_rules"});if(a)throw u;return o.jsx(S,{prev:`/settings/locations/${e}`,children:p&&o.jsx(je,{shippingOption:p})})}export{Ue as Component};
